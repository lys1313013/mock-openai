<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock OpenAI 配置中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .main-card { max-width: 1100px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .nav-tabs { background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .nav-link { padding: 15px 25px; border: none; color: #666; font-weight: 500; border-radius: 0; }
        .nav-link.active { background: white; color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        .tab-content { padding: 30px; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #333; border-left: 4px solid #0d6efd; padding-left: 10px; }
        .json-editor { font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 14px; height: 500px; background: #fdfdfd; }
        .preset-item { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fafafa; }
        .status-msg { position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 250px; display: none; }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Mock OpenAI 配置中心</h4>
            <div>
                <a href="/chat" class="btn btn-outline-primary me-2">对话测试</a>
                <button id="save-btn" class="btn btn-primary px-4">保存所有更改</button>
            </div>
        </div>

        <ul class="nav nav-tabs" id="configTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button">通用设置</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="proxy-tab" data-bs-toggle="tab" data-bs-target="#proxy" type="button">代理配置</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="presets-tab" data-bs-toggle="tab" data-bs-target="#presets" type="button">预设响应</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button">高级(JSON)</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- 通用设置 -->
            <div class="tab-pane fade show active" id="general">
                <div class="section-title">核心模式</div>
                <div class="mb-4">
                    <label class="form-label">运行模式</label>
                    <select id="mode" class="form-select">
                        <option value="mock">Mock 模式 (返回本地模拟数据)</option>
                        <option value="proxy">Proxy 模式 (转发到真实 API)</option>
                    </select>
                    <div class="form-text">决定了服务器接收到请求时的默认行为。</div>
                </div>

                <div class="section-title">Mock 默认返回 (兜底配置)</div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">默认模型名称</label>
                        <input type="text" id="mock-default-model" class="form-control" placeholder="gpt-3.5-turbo">
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">默认回复内容</label>
                        <textarea id="mock-default-content" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- 代理配置 -->
            <div class="tab-pane fade" id="proxy">
                <div class="section-title">真实 API 转发设置</div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="proxy-enabled">
                    <label class="form-check-label" for="proxy-enabled">启用代理转发功能</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">目标 API URL</label>
                    <input type="text" id="target-url" class="form-control" placeholder="https://api.openai.com/v1/chat/completions">
                </div>
                <div class="mb-3">
                    <label class="form-label">API Key</label>
                    <input type="password" id="api-key" class="form-control" placeholder="sk-...">
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">强制指定模型 (可选)</label>
                        <input type="text" id="proxy-model" class="form-control" placeholder="不填则使用请求中的模型">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">超时时间 (秒)</label>
                        <input type="number" id="timeout" class="form-control" value="60">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="log-requests">
                            <label class="form-check-label" for="log-requests">记录请求日志</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="log-responses">
                            <label class="form-check-label" for="log-responses">记录响应日志</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 预设响应 -->
            <div class="tab-pane fade" id="presets">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="section-title mb-0">命中规则与响应</div>
                    <button class="btn btn-outline-primary btn-sm" onclick="addNewPreset()">添加新预设</button>
                </div>
                <div id="presets-list">
                    <!-- 动态加载预设项目 -->
                </div>
            </div>

            <!-- 高级(JSON) -->
            <div class="tab-pane fade" id="advanced">
                <div class="section-title">原始配置文件编辑</div>
                <div class="alert alert-warning py-2 small">注意：直接修改 JSON 可能会覆盖上述标签页中的设置。</div>
                <textarea id="json-config" class="form-control json-editor"></textarea>
            </div>
        </div>
    </div>

    <div id="status-msg" class="alert alert-success status-msg shadow"></div>

    <!-- 预设编辑模态框 (简单起见，这里直接用 JSON 编辑单个预设) -->
    <div class="modal fade" id="presetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑预设响应</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="current-preset-json" class="form-control font-monospace" rows="15"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCurrentPreset()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let fullConfig = {};
        let editingPresetIndex = -1;
        const presetModal = new bootstrap.Modal(document.getElementById('presetModal'));

        // 初始化
        window.onload = fetchConfig;

        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                fullConfig = await response.json();
                renderUI();
            } catch (err) {
                showStatus('加载失败: ' + err.message, 'danger');
            }
        }

        function renderUI() {
            // 通用
            document.getElementById('mode').value = fullConfig.mode || 'mock';
            const mockConf = fullConfig.mock_config || {};
            document.getElementById('mock-default-model').value = mockConf.default_model || '';
            document.getElementById('mock-default-content').value = mockConf.default_content || '';

            // 代理
            const proxyConf = fullConfig.proxy_config || {};
            document.getElementById('proxy-enabled').checked = proxyConf.enabled || false;
            document.getElementById('target-url').value = proxyConf.target_url || '';
            document.getElementById('api-key').value = proxyConf.api_key || '';
            document.getElementById('proxy-model').value = proxyConf.model || '';
            document.getElementById('timeout').value = proxyConf.timeout || 60;
            document.getElementById('log-requests').checked = proxyConf.log_requests !== false;
            document.getElementById('log-responses').checked = proxyConf.log_responses !== false;

            // 预设
            renderPresets();

            // 高级
            document.getElementById('json-config').value = JSON.stringify(fullConfig, null, 2);
        }

        function renderPresets() {
            const list = document.getElementById('presets-list');
            list.innerHTML = '';
            const presets = fullConfig.preset_responses || [];
            
            presets.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'preset-item';
                const model = p.match_conditions?.model || '任意模型';
                const msg = p.match_conditions?.messages?.[0]?.content || '无消息条件';
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold text-primary mb-1">模型条件: ${model}</div>
                            <div class="small text-muted mb-2 text-truncate" style="max-width: 600px;">匹配消息: ${msg}</div>
                            <div class="badge bg-info text-dark">${p.stream_response_chunks ? '流式' : '非流式'}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPreset(${index})">编辑</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePreset(${index})">删除</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function editPreset(index) {
            editingPresetIndex = index;
            const preset = fullConfig.preset_responses[index];
            document.getElementById('current-preset-json').value = JSON.stringify(preset, null, 2);
            presetModal.show();
        }

        function addNewPreset() {
            editingPresetIndex = -1;
            const template = {
                "match_conditions": { "model": "gpt-3.5-turbo", "messages": [{"role": "user", "content": "你好"}] },
                "response": { "choices": [{"message": {"role": "assistant", "content": "你好，我是模拟回复"}}] }
            };
            document.getElementById('current-preset-json').value = JSON.stringify(template, null, 2);
            presetModal.show();
        }

        function saveCurrentPreset() {
            try {
                const updated = JSON.parse(document.getElementById('current-preset-json').value);
                if (!fullConfig.preset_responses) fullConfig.preset_responses = [];
                
                if (editingPresetIndex === -1) {
                    fullConfig.preset_responses.push(updated);
                } else {
                    fullConfig.preset_responses[editingPresetIndex] = updated;
                }
                presetModal.hide();
                renderPresets();
                syncToJSON();
            } catch (err) {
                alert('JSON 格式错误: ' + err.message);
            }
        }

        function deletePreset(index) {
            if (confirm('确定要删除这个预设吗？')) {
                fullConfig.preset_responses.splice(index, 1);
                renderPresets();
                syncToJSON();
            }
        }

        function syncToJSON() {
            // 从各表单同步回 fullConfig
            fullConfig.mode = document.getElementById('mode').value;
            
            fullConfig.mock_config = {
                default_model: document.getElementById('mock-default-model').value,
                default_content: document.getElementById('mock-default-content').value
            };

            fullConfig.proxy_config = {
                enabled: document.getElementById('proxy-enabled').checked,
                target_url: document.getElementById('target-url').value,
                api_key: document.getElementById('api-key').value,
                model: document.getElementById('proxy-model').value,
                timeout: parseInt(document.getElementById('timeout').value),
                log_requests: document.getElementById('log-requests').checked,
                log_responses: document.getElementById('log-responses').checked
            };

            document.getElementById('json-config').value = JSON.stringify(fullConfig, null, 2);
        }

        document.getElementById('save-btn').onclick = async () => {
            syncToJSON();
            // 如果高级 Tab 的 JSON 被手动修改过，以 JSON 为准
            try {
                const finalConfig = JSON.parse(document.getElementById('json-config').value);
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalConfig)
                });
                
                if (response.ok) {
                    showStatus('所有配置已成功保存！', 'success');
                    fetchConfig();
                } else {
                    const err = await response.json();
                    showStatus('保存失败: ' + (err.error || '未知错误'), 'danger');
                }
            } catch (err) {
                showStatus('保存失败: ' + err.message, 'danger');
            }
        };

        function showStatus(msg, type) {
            const el = document.getElementById('status-msg');
            el.textContent = msg;
            el.className = `alert alert-${type} status-msg shadow d-block`;
            setTimeout(() => { el.className = 'alert status-msg'; }, 3000);
        }
    </script>
</body>
</html>
